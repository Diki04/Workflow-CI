name: MLflow CI-CD Kriteria 3 (Gym Regression)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write 

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Persiapan
    - name: 1. Checkout Repository
      uses: actions/checkout@v4

    - name: 2. Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: "3.12.7"

    # 2. Instalasi (Pip-based, lebih cepat)
    - name: 3. Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r MLProject/requirements.txt
    
    # 3. Menjalankan Training
    - name: 4. Run MLflow Project (Training)
      run: |
        # Jalankan 'main' entry point dari file MLProject
        mlflow run MLProject --env-manager=local

    #  4. Menyimpan Artefak
    - name: 5. Get latest MLflow run_id
      id: get_run_id 
      run: |
        # Cari RUN_ID terakhir di dalam folder mlruns
        RUN_ID=$(ls -td MLProject/mlruns/0/*/ | head -n 1 | cut -d'/' -f4)
        echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "Latest run_id: $RUN_ID"

    - name: 6. Upload Artifacts (Model)
      uses: actions/upload-artifact@v4
      with:
        name: ml-model-artifacts
        path: MLProject/mlruns 

    - name: 6b. Upload Artifacts to Google Drive
      uses: anothrNick/drive-upload@v1.0.0
      with:
        source: MLProject/mlruns
        destination: ${{ secrets.GDRIVE_DESTINATION_FOLDER_ID }}
      env: 
        GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}

    - name: 7. Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    #  5. Build & Push Docker
    - name: 8. Build Docker Image with MLflow
      run: |
        # Ambil RUN_ID dari langkah 5
        RUN_ID=${{ steps.get_run_id.outputs.run_id }}
        
        # Beritahu MLflow di mana harus mencari 'mlruns'
        export MLFLOW_TRACKING_URI=MLProject/mlruns
        
        echo "Membangun Docker image untuk RUN_ID: $RUN_ID dari $MLFLOW_TRACKING_URI"
        
        # Sekarang sintaks 'runs:/' akan berfungsi
        mlflow models build-docker \
          --model-uri "MLProject/mlruns/0/$RUN_ID/artifacts/random_forest_model" \
          --name "firecrown/model-gym-ci" \
          --env-manager=local

    - name: 9. Tag and Push Docker Image
      run: |
        # Tag image yang di-build di Langkah 8
        docker tag "firecrown/model-gym-ci" "${{ secrets.DOCKERHUB_USERNAME }}/model-gym-ci:latest"
        
        # Push image ke Docker Hub
        docker push "${{ secrets.DOCKERHUB_USERNAME }}/model-gym-ci:latest"

    # 6. Push Artefak kembali ke Repo 
    - name: 10. Commit and push ML artifacts
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Cari file artefak di 'MLProject/'
        git add MLProject/*.png MLProject/*.json
        
        # Cek jika ada perubahan untuk di-commit
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m " [CI] Add regression plot and metrics"
          git push
        else
          echo "Tidak ada artefak baru untuk di-commit."
        fi