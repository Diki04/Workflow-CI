name: MLflow CI-CD Kriteria 3 (Gym Classification)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write 

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Persiapan
    - name: 1. Checkout Repository
      uses: actions/checkout@v4

    - name: 2. Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: "3.12.7"

    # 2. Instalasi (Pip-based, lebih cepat)
    - name: 3. Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r MLProject/requirements.txt
    
    # 3. Menjalankan Training
    - name: 4. Run MLflow Project (Training)
      run: |
        # Jalankan 'main' entry point dari file MLProject
        mlflow run MLProject --env-manager=local

    #  4. Menyimpan Artefak
    # 4. Menyimpan Artefak & Mengambil ID (DIPERBAIKI)
    - name: 5. Get latest MLflow run_id
      id: get_run_id 
      run: |
        # Gunakan Absolute Path agar perintah ls tidak bingung
        SEARCH_DIR="${{ github.workspace }}/MLProject/mlruns/0"
        
        # Ambil folder terakhir yang dimodifikasi, lalu ambil nama basenya saja (bersih dari slash)
        # 'basename' jauh lebih aman daripada 'cut' untuk mengambil nama folder
        LATEST_PATH=$(ls -td "$SEARCH_DIR"/*/ | head -n 1)
        RUN_ID=$(basename "$LATEST_PATH")
        
        # Validasi: Pastikan RUN_ID tidak kosong
        if [ -z "$RUN_ID" ]; then
          echo "‚ùå Error: Tidak dapat menemukan RUN_ID di $SEARCH_DIR"
          exit 1
        fi
        
        echo "‚úÖ Ditemukan RUN_ID: $RUN_ID"
        
        # Simpan ke output
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

    - name: 6. Upload Artifacts (Model)
      uses: actions/upload-artifact@v4
      with:
        name: ml-model-artifacts
        path: MLProject/mlruns 

    - name: 7. Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 5. Build & Push Docker (DIPERBAIKI)
    - name: 8. Build Docker Image with MLflow
      run: |
        # Ambil RUN_ID yang sudah dibersihkan dari langkah 5
        RUN_ID="${{ steps.get_run_id.outputs.run_id }}"
        
        # KUNCI KEBERHASILAN: Gunakan 'file://' + Absolute Path
        # Ini memaksa MLflow membaca database di lokasi yang TEPAT
        export MLFLOW_TRACKING_URI="file://${{ github.workspace }}/MLProject/mlruns"
        
        echo "üîç Debug Info:"
        echo "   RUN_ID: $RUN_ID"
        echo "   URI   : $MLFLOW_TRACKING_URI"
        
        # Gunakan sintaks standar 'runs:/' 
        # MLflow akan otomatis mencari folder artifact berdasarkan ID dan URI di atas
        mlflow models build-docker \
          --model-uri "runs:/$RUN_ID/model" \
          --name "firecrown/model-gym-ci" \
          --env-manager=local

    - name: 9. Tag and Push Docker Image
      run: |
        # Tag image yang di-build di Langkah 8
        docker tag "firecrown/model-gym-ci" "${{ secrets.DOCKERHUB_USERNAME }}/model-gym-ci:latest"
        
        # Push image ke Docker Hub
        docker push "${{ secrets.DOCKERHUB_USERNAME }}/model-gym-ci:latest"

    # 6. Push Artefak kembali ke Repo 
    - name: 10. Commit and push ML artifacts
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Cari file artefak di 'MLProject/'
        git add MLProject/*.png MLProject/*.json
        
        # Cek jika ada perubahan untuk di-commit
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m " [CI] Add classification matrix and metrics"
          git push
        else
          echo "Tidak ada artefak baru untuk di-commit."
        fi