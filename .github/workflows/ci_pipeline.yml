# File: .github/workflows/ci_pipeline.yml

name: 3. CI Pipeline (MLProject + Docker)

on:
  push:
    branches:
      - main
    paths:
      - 'MLProject/**'
  workflow_dispatch:

jobs:
  run-mlproject-and-build-docker:
    runs-on: ubuntu-latest

    steps:
    
    - name: 1. Checkout repository
      uses: actions/checkout@v4

    # Kembali ke Python 3.11 (modern)
    - name: 2. Setup Conda
      uses: conda-incubator/setup-miniconda@v2
      with:
        auto-update-conda: True
        python-version: 3.12 # <-- Versi Modern

    # Install MLflow terbaru (bukan 2.9.2)
    - name: 3. Install MLflow
      run: |
        pip install --upgrade pip setuptools
        pip install mlflow # <-- Versi Terbaru

    # Langkah 4 & 5 tetap sama
    - name: 4. Run MLflow Project (Training)
      shell: bash -l {0}
      run: |
        mlflow run MLProject/ \
         -P n_estimators=150 \
         -P max_depth=10

    - name: 5. Upload MLflow 'mlruns' artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mlruns-artifact
        path: mlruns/

    # Langkah 6 tetap sama
    - name: 6. Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # ==============================================================
    # LANGKAH 7 YANG BARU (Menggantikan mlflow build-docker)
    # Ini adalah cara yang Anda lihat di contoh sukses
    # ==============================================================
    - name: 7. Build and Push Docker Image (Standar Industri)
      run: |
        # 7.1. Dapatkan RUN_ID dari model yang baru dilatih
        # Ini adalah langkah 'Get latest MLflow run_id' di contoh Anda
        export LATEST_RUN_ID=$(ls -t mlruns/0 | head -n 1)
        echo "LATEST_RUN_ID=${LATEST_RUN_ID}" >> $GITHUB_ENV
        echo "Membangun model dari Run ID: ${LATEST_RUN_ID}"

        # 7.2. Perbarui 'CMD' di Dockerfile dengan RUN_ID yang benar
        # Ini adalah bagian "sulap"nya
        sed -i "s|\[RUN_ID\]|${LATEST_RUN_ID}|g" MLProject/Dockerfile

        # 7.3. Build, Tag, dan Push (seperti di contoh Anda)
        export DOCKER_IMAGE_NAME="firecrown/model-gym-ci" # <-- GANTI INI
        
        # Build
        docker build -t $DOCKER_IMAGE_NAME:latest -f MLProject/Dockerfile ./MLProject
        
        # Tag (sudah dilakukan oleh -t)
        
        # Push
        docker push $DOCKER_IMAGE_NAME:latest